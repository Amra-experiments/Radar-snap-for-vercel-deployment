<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useProjectsStore } from '@/stores/projects'
import Button from 'primevue/button'
import Stepper from 'primevue/stepper'
import StepperPanel from 'primevue/stepperpanel'
import Skeleton from 'primevue/skeleton'
import Tag from 'primevue/tag'
import Divider from 'primevue/divider'

const route = useRoute()
const router = useRouter()
const projectsStore = useProjectsStore()

const projectId = route.params.id as string
const currentStep = ref(0)
const verificationStatus = ref<'waiting' | 'success' | 'failed'>('waiting')

// Helper functions
function getApiEndpoint() {
  return import.meta.env.PROD
    ? 'https://api.radar-snap.com'
    : 'http://localhost:8000'
}

function getSdkUrl() {
  return import.meta.env.PROD
    ? 'https://cdn.radar-snap.com/sdk/latest/radar-snap.min.js'
    : 'http://localhost:8000/static/sdk/radar-snap.js'
}

const project = computed(() => 
  projectsStore.projects.find(p => p.id === projectId)
)

const sdkCode = computed(() => {
  if (!project.value) return ''
  const apiEndpoint = getApiEndpoint()
  const sdkUrl = getSdkUrl()
  const scriptOpen = '<script>'
  const scriptClose = '</' + 'script>'
  return `<!-- Radar-Snap Analytics -->
${scriptOpen}
(function() {
  var config = {
    apiKey: '${project.value.api_key}',
    endpoint: '${apiEndpoint}/api/v1/events/batch',
    debug: false // Set to true for development
  };
  
  var script = document.createElement('script');
  script.src = '${sdkUrl}';
  script.dataset.apiKey = config.apiKey;
  script.dataset.endpoint = config.endpoint;
  script.async = true;
  
  document.head.appendChild(script);
})();
${scriptClose}`
})

const npmInstallCode = computed(() => {
  return `# Install via NPM
npm install @radar-snap/sdk

# Or via Yarn
yarn add @radar-snap/sdk`
})

const npmUsageCode = computed(() => {
  if (!project.value) return ''
  const apiEndpoint = getApiEndpoint()
  return `import RadarSnap from '@radar-snap/sdk'

// Initialize
RadarSnap.init({
  apiKey: '${project.value.api_key}',
  endpoint: '${apiEndpoint}/api/v1/events/batch'
})

// Track page views
RadarSnap.trackPageView()

// Track custom events
RadarSnap.track('button_click', {
  button_id: 'signup',
  page: '/landing'
})`
})

function copyToClipboard(text: string, type: string) {
  navigator.clipboard.writeText(text).then(() => {
    console.log(`${type} copied to clipboard`)
  }).catch(() => {
    console.error('Failed to copy to clipboard')
  })
}

function goToDashboard() {
  projectsStore.switchProject(projectId)
  router.push('/dashboard')
}

function checkConnection() {
  // Simulate checking for events from this project
  verificationStatus.value = 'waiting'
  
  // In a real implementation, this would make an API call to check for events
  setTimeout(() => {
    // Randomly succeed or keep waiting for demo purposes
    verificationStatus.value = Math.random() > 0.3 ? 'success' : 'waiting'
  }, 2000)
}

onMounted(() => {
  // Auto-check connection after 5 seconds
  setTimeout(() => {
    if (verificationStatus.value === 'waiting') {
      checkConnection()
    }
  }, 5000)
})
</script>

<template>
  <div class="min-h-screen bg-gray-50">
    <div class="max-w-6xl mx-auto px-4 py-8">
      <!-- Header -->
      <div class="mb-8">
        <div class="flex items-center gap-2 text-sm text-gray-600 mb-4">
          <router-link to="/dashboard" class="hover:text-blue-600">
            Dashboard
          </router-link>
          <i class="pi pi-angle-right"></i>
          <router-link 
            :to="`/projects/${projectId}/settings`" 
            class="hover:text-blue-600"
          >
            {{ project?.name || 'Project' }}
          </router-link>
          <i class="pi pi-angle-right"></i>
          <span class="text-gray-900 font-medium">Setup</span>
        </div>
        
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
              Setup: {{ project?.name }}
            </h1>
            <p class="text-gray-600">
              Follow these steps to start collecting analytics data
            </p>
          </div>
          
          <div class="text-right">
            <div class="text-sm text-gray-500 mb-1">API Key</div>
            <div class="flex items-center gap-2">
              <code class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">
                {{ project?.api_key?.substring(0, 8) }}...
              </code>
              <Button 
                icon="pi pi-copy"
                size="small"
                text
                @click="copyToClipboard(project?.api_key || '', 'API Key')"
              />
            </div>
          </div>
        </div>
      </div>

      <div v-if="!project" class="space-y-4">
        <Skeleton height="200px" />
        <Skeleton height="300px" />
      </div>

      <!-- Installation Steps -->
      <div v-else class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Setup Steps -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6">
              <h2 class="text-xl font-semibold text-gray-900 mb-6">
                Installation Guide
              </h2>
              
              <Stepper :value="currentStep">
                <!-- Step 1: Copy Script -->
                <StepperPanel header="Add Script to Website">
                  <div class="py-6">
                    <div class="mb-6">
                      <h3 class="text-lg font-medium text-gray-900 mb-3">
                        1. Copy the tracking script
                      </h3>
                      <p class="text-gray-600 mb-4">
                        Add this script to the <code class="bg-gray-100 px-2 py-1 rounded">&lt;head&gt;</code> 
                        section of your website, just before the closing <code class="bg-gray-100 px-2 py-1 rounded">&lt;/head&gt;</code> tag.
                      </p>
                    </div>

                    <div class="bg-gray-900 rounded-lg p-6 relative mb-4">
                      <pre class="text-green-400 text-sm overflow-x-auto whitespace-pre-wrap"><code>{{ sdkCode }}</code></pre>
                      <Button 
                        icon="pi pi-copy"
                        label="Copy Script"
                        class="absolute top-4 right-4"
                        size="small"
                        outlined
                        @click="copyToClipboard(sdkCode, 'Installation script')"
                      />
                    </div>

                    <div class="flex items-start gap-3 p-4 bg-blue-50 rounded-lg border border-blue-200">
                      <i class="pi pi-info-circle text-blue-600 mt-0.5"></i>
                      <div class="text-sm text-blue-900">
                        <p class="font-medium mb-1">Installation Tips:</p>
                        <ul class="space-y-1">
                          <li>â€¢ Place the script in the HTML head section for best performance</li>
                          <li>â€¢ The script loads asynchronously and won't slow down your site</li>
                          <li>â€¢ Works with all modern browsers and frameworks</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </StepperPanel>

                <!-- Step 2: Deploy -->
                <StepperPanel header="Deploy to Production">
                  <div class="py-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">
                      2. Deploy your changes
                    </h3>
                    
                    <div class="space-y-4">
                      <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                          <span class="text-blue-600 font-semibold text-sm">1</span>
                        </div>
                        <div>
                          <h4 class="font-medium text-gray-900 mb-1">Save your changes</h4>
                          <p class="text-sm text-gray-600">
                            Commit the updated HTML file to your version control system
                          </p>
                        </div>
                      </div>

                      <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                          <span class="text-blue-600 font-semibold text-sm">2</span>
                        </div>
                        <div>
                          <h4 class="font-medium text-gray-900 mb-1">Deploy to production</h4>
                          <p class="text-sm text-gray-600">
                            Push your changes live using your normal deployment process
                          </p>
                        </div>
                      </div>

                      <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                          <span class="text-blue-600 font-semibold text-sm">3</span>
                        </div>
                        <div>
                          <h4 class="font-medium text-gray-900 mb-1">Visit your website</h4>
                          <p class="text-sm text-gray-600">
                            Open your live website in a browser to trigger the first event
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </StepperPanel>

                <!-- Step 3: Verify -->
                <StepperPanel header="Verify Installation">
                  <div class="py-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">
                      3. Verify data is flowing
                    </h3>
                    
                    <div class="text-center py-8">
                      <!-- Waiting State -->
                      <div v-if="verificationStatus === 'waiting'" class="space-y-4">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-orange-100 rounded-full animate-pulse">
                          <i class="pi pi-spin pi-spinner text-2xl text-orange-600"></i>
                        </div>
                        <div>
                          <p class="text-lg font-medium text-gray-900 mb-2">
                            Waiting for first event...
                          </p>
                          <p class="text-sm text-gray-600 mb-4">
                            Visit your website to trigger analytics events
                          </p>
                          <Button 
                            label="Check Again"
                            icon="pi pi-refresh"
                            outlined
                            size="small"
                            @click="checkConnection"
                          />
                        </div>
                      </div>

                      <!-- Success State -->
                      <div v-else-if="verificationStatus === 'success'" class="space-y-4">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full">
                          <i class="pi pi-check text-2xl text-green-600"></i>
                        </div>
                        <div>
                          <p class="text-lg font-medium text-gray-900 mb-2">
                            ðŸŽ‰ Installation successful!
                          </p>
                          <p class="text-sm text-gray-600 mb-4">
                            Data is flowing and your analytics are live
                          </p>
                          <div class="flex justify-center gap-3">
                            <Button 
                              label="View Dashboard"
                              icon="pi pi-chart-bar"
                              @click="goToDashboard"
                            />
                            <Button 
                              label="View Documentation"
                              icon="pi pi-book"
                              outlined
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </StepperPanel>
              </Stepper>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- Project Info -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-semibold text-gray-900 mb-4">Project Information</h3>
            <div class="space-y-3 text-sm">
              <div>
                <span class="text-gray-500">Name:</span>
                <span class="ml-2 font-medium">{{ project.name }}</span>
              </div>
              <div>
                <span class="text-gray-500">Website:</span>
                <a 
                  :href="project.website_url" 
                  target="_blank"
                  class="ml-2 text-blue-600 hover:text-blue-700"
                >
                  {{ project.website_url }}
                </a>
              </div>
              <div>
                <span class="text-gray-500">Status:</span>
                <Tag 
                  :value="project.status" 
                  :severity="project.status === 'active' ? 'success' : 'warning'"
                  class="ml-2"
                />
              </div>
            </div>
          </div>

          <!-- NPM Package -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-2 mb-4">
              <i class="pi pi-box text-lg text-blue-600"></i>
              <h3 class="font-semibold text-gray-900">NPM Package</h3>
            </div>
            
            <p class="text-sm text-gray-600 mb-4">
              For React, Vue, Angular, or other JavaScript frameworks:
            </p>
            
            <div class="space-y-4">
              <!-- Install Command -->
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-2">Install</label>
                <div class="bg-gray-900 rounded p-3 relative">
                  <code class="text-green-400 text-xs">{{ npmInstallCode }}</code>
                  <Button 
                    icon="pi pi-copy"
                    size="small"
                    text
                    class="absolute top-1 right-1 text-gray-400"
                    @click="copyToClipboard(npmInstallCode, 'NPM install command')"
                  />
                </div>
              </div>
              
              <!-- Usage -->
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-2">Usage</label>
                <div class="bg-gray-900 rounded p-3 relative">
                  <pre class="text-green-400 text-xs overflow-x-auto"><code>{{ npmUsageCode }}</code></pre>
                  <Button 
                    icon="pi pi-copy"
                    size="small"
                    text
                    class="absolute top-1 right-1 text-gray-400"
                    @click="copyToClipboard(npmUsageCode, 'NPM usage code')"
                  />
                </div>
              </div>
            </div>

            <Divider />
            
            <Button 
              label="View NPM Documentation"
              icon="pi pi-external-link"
              iconPos="right"
              text
              size="small"
              class="w-full"
            />
          </div>

          <!-- Quick Actions -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-semibold text-gray-900 mb-4">Quick Actions</h3>
            <div class="space-y-2">
              <Button 
                label="Project Settings"
                icon="pi pi-cog"
                text
                size="small"
                class="w-full justify-start"
                @click="router.push(`/projects/${projectId}/settings`)"
              />
              <Button 
                label="Invite Team"
                icon="pi pi-users"
                text
                size="small"
                class="w-full justify-start"
                @click="router.push(`/projects/${projectId}/team`)"
              />
              <Button 
                label="View Analytics"
                icon="pi pi-chart-bar"
                text
                size="small"
                class="w-full justify-start"
                @click="goToDashboard"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
/* Custom code block styling */
pre {
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
}

/* Stepper customization */
.p-stepper .p-stepper-header {
  padding: 1rem;
}

.p-stepper .p-stepper-content {
  padding: 0;
}
</style>